#!/usr/bin/env bash

current_dir="$(dirname $0)"
cd $current_dir/..
all_services=( 
    nginx:nginx
    php_fpm:php-fpm8
    mariadb:mysqld
    postgresql:postgres
    gitea:gitea
)

case $1 in
    init)
    ./scripts/run.sh >run.log 2>&1
    ;;
    rm)
    docker rm pi >/dev/null
    sudo rm -r /data/pi
    ;;
    start)
    source /data/pi/init.conf
    docker update --memory ${MEMORY}m --memory-swap $((MEMORY * 2))m pi >/dev/null
    docker start --attach pi >run.log 2>&1 &
    ;;
    stop)
    docker stop pi >/dev/null
    ;;
    restart)
    ./bin/pictl stop
    ./bin/pictl start
    ;;
    rebuild)
    ./bin/pictl stop
    ./bin/pictl rm
    docker build -t pi .
    ;;
    enter)
    docker exec -it pi ash
    ;;
    status)
    docker exec pi check && \
        cat /data/pi/pi.log
    ;;
    tail)
    docker exec pi ash -c "tail -f /data/log/init/*.log"
    ;;
    allocate)
    memory_line=$(sed -n '/MEMORY/=' /data/pi/init.conf)
    sed -i "${memory_line}s/.*/MEMORY=$2 /" /data/pi/init.conf
    ./bin/pictl restart
    ;;
    service)
    case $2 in
        start)
        for i in ${@:3}; do
            docker exec pi check
            if grep "$i" /data/pi/pi.log | grep "running" >/dev/null; then
                echo "$i is already running."
            else
                docker exec pi ash -c "[[ -e /run/pi/$i.fifo ]]" && \
                    docker exec pi ash -c "echo true > /run/pi/$i.fifo"
            fi
        done
        ;;
        stop)
        for i in ${@:3}; do
            for j in ${all_services[@]}; do
                if [[ $j = $i:* ]]; then
                    target=$(echo $j | sed 's/.*://')
                    docker exec pi ash -c "killall $target"
                fi
            done
        done
        ;;
        restart)
        ./bin/pictl service stop ${@:3}
        ./bin/pictl service start ${@:3}
        ;;
        enable)
        for i in ${@:3}; do
            sed -i "/$i/ s/false/true/g" /data/pi/init.conf
        done
        ;;
        disable)
        for i in ${@:3}; do
            sed -i "/$i/ s/true/false/g" /data/pi/init.conf
        done
        ;;
        list)
        for j in ${all_services[@]}; do
            echo $(echo $j | sed 's/:.*//')
        done
        ;;
    esac
    ;;
esac