#!/usr/bin/env bash

current_dir="$(dirname $0)"
cd $current_dir/..
all_services=( 
    nginx:nginx
    php-fpm:php-fpm8
    mariadb:mysqld
    postgresql:postgres
    gitea:gitea
)

case $1 in
    run)
    ./run.sh >run.log 2>&1 &
    echo "Pi container started"
    ;;
    stop)
    docker stop pi >/dev/null
    echo "Pi container stopped"
    ;;
    rm)
    docker rm pi >/dev/null
    echo "Pi container removed"
    ;;
    build)
    docker build -t pi .
    ;;
    rebuild)
    ./bin/pictl stop
    ./bin/pictl rm && ./bin/pictl build
    ;;
    enter)
    docker exec -it pi ash
    ;;
    service)
    case $2 in
        start)
        for i in ${@:3}; do
            echo true > /run/pi/$i.fifo
        done
        ;;
        stop)
        for i in ${@:3}; do
            for j in ${all_services[@]}; do
                if [[ $j = $i:* ]]; then
                    target=$(echo $j | sed 's/.*://')
                    docker exec -it pi ash -c "killall $target"
                fi
            done
        done
        ;;
        restart)
        ./bin/pictl service stop ${@:3}
        ./bin/pictl service start ${@:3}
        ;;
        list)
        for j in ${all_services[@]}; do
            echo $(echo $j | sed 's/:.*//')
        done
        ;;
    esac
    ;;
esac