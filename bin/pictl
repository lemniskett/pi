#!/usr/bin/env bash

asroot(){
    [[ $EUID -ne 0 ]] && echo "Run this as root!" && exit 130
}



current_dir="$(dirname $0)"
cd $current_dir/..

case $1 in
    init)
    mkdir -p out
    for i in ${@:2}; do
        ./$i/run.sh > out/$i.out 2>&1 &
    done
    ;;
    start)
    for i in ${@:2}; do
        docker container start --attach $i-pi >>out/$i.out 2>&1 &
    done
    ;;
    stop)
    for i in ${@:2}; do
        docker container stop $i-pi
    done
    ;;
    build)
    asroot
    ./build.sh
    ;;
    tail)
    tail -f out/$2.out
    ;;
    set-memory)
    mem="$3"
    docker update --memory ${mem}m --memory-swap $((mem * 2))m $2-pi >/dev/null
    ;;
    status)
    docker stats --format '{{.Name}}\t{{.MemUsage}}' --no-stream >/tmp/pictl.tmp
    for i in nginx php-fpm8 mysql postgresql gitea; do
        mem="$(grep ${i}-pi /tmp/pictl.tmp | awk '{print $2}')"
        mem="$(printf '%.0f' ${mem/MiB/})"
        limit="$(grep ${i}-pi /tmp/pictl.tmp | awk '{print $4}')"
        limit="$(printf '%.0f' ${limit/MiB/})"
        name="$(echo $i | sed 's/-/_/g')"
        echo "${name}_running=$([[ $(cat /tmp/pictl.tmp) = *$i* ]] && echo true || echo false)"
        echo "${name}_usage=$mem"
        echo "${name}_limit=$limit"
    done
    ;;
esac